<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç Supabase Realtime</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status { 
            padding: 15px; 
            margin: 15px 0; 
            border-radius: 8px; 
            border-left: 4px solid;
        }
        .connected { 
            background-color: #d4edda; 
            color: #155724; 
            border-left-color: #28a745;
        }
        .disconnected { 
            background-color: #f8d7da; 
            color: #721c24; 
            border-left-color: #dc3545;
        }
        .log { 
            background-color: #f8f9fa; 
            border: 1px solid #dee2e6; 
            padding: 20px; 
            height: 350px; 
            overflow-y: auto; 
            font-family: 'Courier New', monospace; 
            font-size: 13px;
            border-radius: 8px;
            white-space: pre-wrap;
        }
        button { 
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white; 
            border: none; 
            padding: 12px 20px; 
            margin: 8px; 
            border-radius: 6px; 
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        button:hover { 
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,123,255,0.3);
        }
        button:disabled { 
            background: #6c757d; 
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .config {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .config input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .event-item {
            background: #f0f8ff;
            border-left: 3px solid #2196f3;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ –¢–µ—Å—Ç Supabase Realtime</h1>
        
        <!-- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è -->
        <div class="config">
            <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:</h3>
            <input id="supabaseUrl" type="text" placeholder="Supabase URL" value="https://your-project.supabase.co">
            <input id="supabaseKey" type="text" placeholder="Supabase Anon Key" value="your-anon-key">
            <button onclick="initSupabase()">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å Supabase</button>
        </div>
        
        <!-- –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è -->
        <div id="status" class="status disconnected">
            ‚ùå –ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ Supabase Realtime
        </div>
        
        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
        <div>
            <button id="connectBtn" onclick="connect()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
            <button id="disconnectBtn" onclick="disconnect()" disabled>–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
            <button onclick="clearLog()">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
            <button onclick="testConnection()">–¢–µ—Å—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</button>
        </div>
        
        <!-- –¢–µ—Å—Ç–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
        <h3>–¢–µ—Å—Ç–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –¥–∞–Ω–Ω—ã–º–∏:</h3>
        <div>
            <button onclick="insertTestEquipment()">–î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</button>
            <button onclick="updateTestEquipment()">–û–±–Ω–æ–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</button>
            <button onclick="deleteTestEquipment()">–£–¥–∞–ª–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</button>
            <button onclick="fetchEquipment()">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</button>
        </div>
        
        <!-- –õ–æ–≥ —Å–æ–±—ã—Ç–∏–π -->
        <h3>–õ–æ–≥ —Å–æ–±—ã—Ç–∏–π Realtime:</h3>
        <div id="log" class="log">–õ–æ–≥ –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å...</div>
    </div>

    <script>
        let supabase = null;
        let channel = null;
        let testEquipmentId = null;
        
        const statusEl = document.getElementById('status');
        const logEl = document.getElementById('log');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logEl.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }
        
        function updateStatus(connected, message = '') {
            if (connected) {
                statusEl.innerHTML = '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ Supabase Realtime ' + message;
                statusEl.className = 'status connected';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            } else {
                statusEl.innerHTML = '‚ùå –ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ Supabase Realtime ' + message;
                statusEl.className = 'status disconnected';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            }
        }
        
        function initSupabase() {
            const url = document.getElementById('supabaseUrl').value;
            const key = document.getElementById('supabaseKey').value;
            
            if (!url || !key) {
                addLog('‚ùå –í–≤–µ–¥–∏—Ç–µ URL –∏ –∫–ª—é—á Supabase', 'error');
                return;
            }
            
            try {
                supabase = window.supabase.createClient(url, key, {
                    realtime: {
                        params: {
                            eventsPerSecond: 10
                        }
                    }
                });
                addLog('‚úÖ Supabase –∫–ª–∏–µ–Ω—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'success');
            } catch (error) {
                addLog('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Supabase: ' + error.message, 'error');
            }
        }
        
        function connect() {
            if (!supabase) {
                addLog('‚ùå –°–Ω–∞—á–∞–ª–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ Supabase', 'error');
                return;
            }
            
            addLog('üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase Realtime...');
            
            try {
                // –°–æ–∑–¥–∞–µ–º –∫–∞–Ω–∞–ª –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã equipment
                channel = supabase
                    .channel('public:equipment')
                    .on(
                        'postgres_changes',
                        {
                            event: '*',
                            schema: 'public',
                            table: 'equipment'
                        },
                        (payload) => {
                            addLog('üì® –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–±—ã—Ç–∏–µ: ' + JSON.stringify({
                                event: payload.eventType,
                                table: payload.table,
                                record: payload.new || payload.old
                            }, null, 2), 'success');
                        }
                    )
                    .subscribe((status) => {
                        addLog(`üì° –°—Ç–∞—Ç—É—Å –∫–∞–Ω–∞–ª–∞: ${status}`);
                        
                        if (status === 'SUBSCRIBED') {
                            updateStatus(true);
                            addLog('‚úÖ –£—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ Realtime', 'success');
                        } else if (status === 'CHANNEL_ERROR') {
                            updateStatus(false, '(–æ—à–∏–±–∫–∞ –∫–∞–Ω–∞–ª–∞)');
                            addLog('‚ùå –û—à–∏–±–∫–∞ –∫–∞–Ω–∞–ª–∞ Realtime', 'error');
                        } else if (status === 'TIMED_OUT') {
                            updateStatus(false, '(—Ç–∞–π–º–∞—É—Ç)');
                            addLog('‚ùå –¢–∞–π–º–∞—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Realtime', 'error');
                        }
                    });
                    
            } catch (error) {
                addLog('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + error.message, 'error');
                updateStatus(false, '(–æ—à–∏–±–∫–∞)');
            }
        }
        
        function disconnect() {
            if (channel) {
                supabase.removeChannel(channel);
                channel = null;
                addLog('üîå –û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç Realtime', 'info');
                updateStatus(false);
            }
        }
        
        async function testConnection() {
            if (!supabase) {
                addLog('‚ùå Supabase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'error');
                return;
            }
            
            try {
                addLog('üîç –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö...');
                const { data, error } = await supabase
                    .from('equipment')
                    .select('count', { count: 'exact', head: true });
                
                if (error) {
                    addLog('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î: ' + error.message, 'error');
                } else {
                    addLog(`‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î —É—Å–ø–µ—à–Ω–æ. –ó–∞–ø–∏—Å–µ–π –≤ equipment: ${data}`, 'success');
                }
            } catch (error) {
                addLog('‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: ' + error.message, 'error');
            }
        }
        
        async function insertTestEquipment() {
            if (!supabase) {
                addLog('‚ùå Supabase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'error');
                return;
            }
            
            try {
                const testData = {
                    uuid: 'test_' + Date.now(),
                    name: '–¢–µ—Å—Ç–æ–≤–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ ' + new Date().toLocaleTimeString(),
                    status: 'available',
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                
                addLog('üì§ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è...');
                const { data, error } = await supabase
                    .from('equipment')
                    .insert(testData)
                    .select()
                    .single();
                
                if (error) {
                    addLog('‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è: ' + error.message, 'error');
                } else {
                    testEquipmentId = data.uuid;
                    addLog('‚úÖ –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ: ' + JSON.stringify(data), 'success');
                }
            } catch (error) {
                addLog('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }
        
        async function updateTestEquipment() {
            if (!supabase || !testEquipmentId) {
                addLog('‚ùå –°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ', 'error');
                return;
            }
            
            try {
                addLog('üìù –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è...');
                const { data, error } = await supabase
                    .from('equipment')
                    .update({
                        name: '–û–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ ' + new Date().toLocaleTimeString(),
                        status: 'in-use',
                        updated_at: new Date().toISOString()
                    })
                    .eq('uuid', testEquipmentId)
                    .select()
                    .single();
                
                if (error) {
                    addLog('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ' + error.message, 'error');
                } else {
                    addLog('‚úÖ –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ: ' + JSON.stringify(data), 'success');
                }
            } catch (error) {
                addLog('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }
        
        async function deleteTestEquipment() {
            if (!supabase || !testEquipmentId) {
                addLog('‚ùå –°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ', 'error');
                return;
            }
            
            try {
                addLog('üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è...');
                const { error } = await supabase
                    .from('equipment')
                    .delete()
                    .eq('uuid', testEquipmentId);
                
                if (error) {
                    addLog('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + error.message, 'error');
                } else {
                    addLog('‚úÖ –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ: ' + testEquipmentId, 'success');
                    testEquipmentId = null;
                }
            } catch (error) {
                addLog('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }
        
        async function fetchEquipment() {
            if (!supabase) {
                addLog('‚ùå Supabase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'error');
                return;
            }
            
            try {
                addLog('üìã –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è...');
                const { data, error } = await supabase
                    .from('equipment')
                    .select('uuid, name, status, created_at')
                    .order('created_at', { ascending: false })
                    .limit(5);
                
                if (error) {
                    addLog('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message, 'error');
                } else {
                    addLog('‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: ' + data.length);
                    data.forEach(item => {
                        addLog(`  ‚Ä¢ ${item.name} (${item.status}) - ${item.uuid}`);
                    });
                }
            } catch (error) {
                addLog('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }
        
        function clearLog() {
            logEl.innerHTML = '–õ–æ–≥ –æ—á–∏—â–µ–Ω...\n';
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        addLog('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ Supabase –∏ –Ω–∞–∂–º–∏—Ç–µ "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å"');
        addLog('üí° –ü–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–∞–∂–º–∏—Ç–µ "–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è" –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è Realtime');
        addLog('üìù –û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –≤–∫–ª–∞–¥–∫–∞—Ö –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏');
    </script>
</body>
</html>
