# Новые поля пользователей: Никнейм и Логин

## Обзор

В систему управления пользователями добавлены два новых поля:
- **`nickname`** - Отображаемое имя пользователя
- **`login`** - Логин для входа в систему

## Структура полей

### Никнейм (nickname)
- **Тип**: VARCHAR(50)
- **Обязательное**: Да
- **Уникальное**: Да
- **Описание**: Пользовательское отображаемое имя
- **Разрешенные символы**: Буквы (русские и английские), цифры, пробелы, подчеркивания, дефисы
- **Длина**: 2-50 символов

### Логин (login)
- **Тип**: VARCHAR(50)
- **Обязательное**: Да
- **Уникальное**: Да
- **Описание**: Логин для входа в систему
- **Разрешенные символы**: Только латинские буквы, цифры, подчеркивания
- **Длина**: 3-50 символов

## Отличия от существующих полей

### Username vs Login vs Nickname

| Поле | Назначение | Пример | Ограничения |
|------|------------|---------|-------------|
| `username` | Внутренний идентификатор | `ivan.petrov` | Только латиница, цифры, подчеркивания |
| `login` | Логин для входа | `ivan.petrov` | Только латиница, цифры, подчеркивания |
| `nickname` | Отображаемое имя | `Иван Петров` | Русские буквы, пробелы, дефисы |

## Миграция базы данных

### Файл: `004_add_nickname.sql`

```sql
-- Добавляем новые поля
ALTER TABLE users ADD COLUMN IF NOT EXISTS nickname VARCHAR(50);
ALTER TABLE users ADD COLUMN IF NOT EXISTS login VARCHAR(50);

-- Создаем индексы
CREATE INDEX IF NOT EXISTS idx_users_nickname ON users(nickname);
CREATE INDEX IF NOT EXISTS idx_users_login ON users(login);

-- Заполняем существующие записи
UPDATE users SET nickname = username, login = username WHERE nickname IS NULL OR login IS NULL;

-- Делаем поля обязательными
ALTER TABLE users ALTER COLUMN nickname SET NOT NULL;
ALTER TABLE users ALTER COLUMN login SET NOT NULL;

-- Добавляем уникальные ограничения
ALTER TABLE users ADD CONSTRAINT users_nickname_unique UNIQUE (nickname);
ALTER TABLE users ADD CONSTRAINT users_login_unique UNIQUE (login);
```

## Валидация

### Backend валидация

```typescript
// Никнейм
body('nickname')
  .notEmpty()
  .withMessage('Nickname is required')
  .isLength({ min: 2, max: 50 })
  .withMessage('Nickname must be between 2 and 50 characters')
  .matches(/^[a-zA-Zа-яА-Я0-9_\s-]+$/)
  .withMessage('Nickname can contain letters, numbers, spaces, underscores and hyphens')

// Логин
body('login')
  .notEmpty()
  .withMessage('Login is required')
  .isLength({ min: 3, max: 50 })
  .withMessage('Login must be between 3 and 50 characters')
  .matches(/^[a-zA-Z0-9_]+$/)
  .withMessage('Login can only contain letters, numbers, and underscores')
```

### Frontend валидация

- Проверка на заполненность всех обязательных полей
- Валидация формата в реальном времени
- Отображение ошибок валидации

## API изменения

### Создание пользователя

```typescript
POST /api/users
{
  "username": "ivan.petrov",
  "login": "ivan.petrov",
  "nickname": "Иван Петров",
  "email": "ivan@company.com",
  "password": "SecurePass123!",
  "full_name": "Иван Петров",
  "role": "operator"
}
```

### Обновление пользователя

```typescript
PUT /api/users/:id
{
  "login": "new.login",
  "nickname": "Новый Никнейм"
}
```

## Поиск и фильтрация

### Расширенный поиск

Поиск теперь работает по всем полям:
- `username` - внутренний идентификатор
- `login` - логин для входа
- `nickname` - отображаемое имя
- `email` - электронная почта
- `full_name` - полное имя

### SQL запрос

```sql
SELECT * FROM users 
WHERE username ILIKE '%search%' 
   OR login ILIKE '%search%' 
   OR nickname ILIKE '%search%' 
   OR email ILIKE '%search%' 
   OR full_name ILIKE '%search%'
```

## Интерфейс пользователя

### Форма создания пользователя

- **Имя пользователя**: Внутренний идентификатор
- **Логин**: Логин для входа в систему
- **Никнейм**: Отображаемое имя
- **Email**: Электронная почта
- **Полное имя**: Полное имя пользователя

### Таблица пользователей

Добавлены новые колонки:
- **Логин**: Отображение логина пользователя
- **Никнейм**: Отображение никнейма пользователя

### Диалог редактирования

Все поля доступны для редактирования:
- Изменение логина
- Изменение никнейма
- Изменение других полей

## Безопасность

### Проверка уникальности

При создании и обновлении пользователя проверяется уникальность:
- `username` - должен быть уникальным
- `login` - должен быть уникальным
- `nickname` - должен быть уникальным
- `email` - должен быть уникальным

### Валидация входных данных

- Проверка формата полей
- Проверка длины полей
- Проверка разрешенных символов
- Санитизация входных данных

## Использование

### Для администраторов

1. **Создание пользователя**:
   - Заполните все обязательные поля
   - Убедитесь в уникальности логина и никнейма
   - Используйте валидацию для проверки корректности

2. **Редактирование пользователя**:
   - Измените нужные поля
   - Система автоматически проверит уникальность
   - Сохраните изменения

### Для пользователей

- **Логин**: Используется для входа в систему
- **Никнейм**: Отображается в интерфейсе
- **Username**: Внутренний идентификатор (не изменяется)

## Будущие улучшения

### Планируемые функции

- Автоматическая генерация логинов
- Предложения никнеймов на основе имени
- Проверка доступности логина в реальном времени
- Интеграция с внешними системами аутентификации

### Технические улучшения

- Кэширование проверок уникальности
- Оптимизация поиска по новым полям
- Расширенная аналитика использования
- API для массового обновления

## Заключение

Добавление полей `nickname` и `login` значительно улучшает систему управления пользователями:

- **Гибкость**: Разделение внутреннего идентификатора, логина и отображаемого имени
- **Удобство**: Пользователи могут иметь читаемые никнеймы
- **Безопасность**: Строгая валидация и проверка уникальности
- **Масштабируемость**: Подготовка к интеграции с внешними системами
