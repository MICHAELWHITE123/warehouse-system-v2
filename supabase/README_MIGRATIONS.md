# Миграции базы данных WeareHouse для Supabase

## Обзор

Этот набор миграций создает полную структуру базы данных для системы управления складом оборудования WeareHouse, оптимизированную для PostgreSQL и Supabase.

## Структура миграций

### 1. `20250101_001_initial_schema.sql` - Основная схема
- Создает все необходимые таблицы
- Настраивает индексы для производительности
- Создает триггеры для автоматического обновления
- Настраивает Row Level Security (RLS)
- Создает представления (views)

### 2. `20250101_002_seed_data.sql` - Начальные данные
- Вставляет базовые категории оборудования
- Создает тестовые местоположения
- Добавляет образцы оборудования
- Создает тестовые отгрузки и связанные данные
- Вставляет тестовые записи синхронизации

### 3. `20250101_003_functions_and_api.sql` - Функции и API
- Создает функции для работы с оборудованием
- Добавляет функции для управления отгрузками
- Реализует систему синхронизации
- Создает функции для уведомлений
- Добавляет функции отчетности и аудита

## Применение миграций

### Локальная разработка

1. **Запуск Supabase локально:**
```bash
cd supabase
supabase start
```

2. **Применение миграций:**
```bash
supabase db reset
```

Или по одной:
```bash
supabase db push
```

### Продакшн (Supabase Cloud)

1. **Через Supabase Dashboard:**
   - Перейдите в раздел SQL Editor
   - Выполните каждую миграцию по порядку

2. **Через CLI:**
```bash
supabase db push --db-url "your-production-db-url"
```

## Проверка после применения

### Проверка таблиц
```sql
SELECT 
    schemaname,
    tablename,
    tableowner
FROM pg_tables 
WHERE schemaname = 'public' 
ORDER BY tablename;
```

### Проверка функций
```sql
SELECT 
    routine_name,
    routine_type,
    data_type
FROM information_schema.routines 
WHERE routine_schema = 'public' 
ORDER BY routine_name;
```

### Проверка данных
```sql
-- Количество записей в основных таблицах
SELECT 'categories' as table_name, COUNT(*) as record_count FROM categories
UNION ALL
SELECT 'equipment', COUNT(*) FROM equipment
UNION ALL
SELECT 'shipments', COUNT(*) FROM shipments
ORDER BY table_name;
```

## Основные особенности

### Безопасность
- Row Level Security (RLS) включен для всех таблиц
- Политики доступа настроены для разных ролей пользователей
- Аудит всех изменений через таблицу `change_log`

### Производительность
- Оптимизированные индексы для быстрого поиска
- Представления для сложных запросов
- Функции для массовых операций

### Синхронизация
- Полная система синхронизации между устройствами
- Отслеживание конфликтов и их разрешение
- Хеширование операций для проверки целостности

### Масштабируемость
- UUID для глобальной уникальности
- JSONB поля для гибких данных
- Массивы для тегов и категорий

## Структура таблиц

### Основные таблицы
- `user_profiles` - профили пользователей
- `categories` - категории оборудования
- `locations` - местоположения
- `equipment` - оборудование
- `equipment_stacks` - стеки оборудования
- `shipments` - отгрузки
- `shipment_equipment` - оборудование в отгрузках
- `shipment_stacks` - стеки в отгрузках

### Таблицы синхронизации
- `device_sync_status` - статус устройств
- `sync_operations` - операции синхронизации
- `sync_conflicts` - конфликты синхронизации

### Вспомогательные таблицы
- `change_log` - история изменений
- `notifications` - уведомления
- `user_settings` - настройки пользователей

## API функции

### Оборудование
- `search_equipment()` - поиск оборудования
- `get_equipment_statistics()` - статистика
- `get_equipment_by_category()` - по категории

### Отгрузки
- `create_shipment_with_equipment()` - создание отгрузки
- `get_shipment_details()` - детали отгрузки

### Синхронизация
- `register_device()` - регистрация устройства
- `create_sync_operation()` - создание операции
- `get_device_sync_operations()` - получение операций

### Уведомления
- `create_notification()` - создание уведомления
- `get_user_notifications()` - получение уведомлений

## Триггеры

### Автоматические обновления
- `update_updated_at_column()` - обновление timestamp
- `log_changes()` - логирование изменений
- `notify_equipment_status_change()` - уведомления о статусе
- `update_shipment_counters()` - обновление счетчиков

## Представления (Views)

- `sync_statistics` - статистика синхронизации
- `equipment_full_info` - полная информация об оборудовании
- `shipments_full_info` - детали отгрузок

## Настройка RLS

Все таблицы защищены Row Level Security. Политики настроены следующим образом:

- **user_profiles**: пользователи видят только свой профиль
- **Основные таблицы**: все пользователи имеют полный доступ
- **Синхронизация**: доступ в зависимости от устройства

## Мониторинг и обслуживание

### Очистка логов
```sql
SELECT cleanup_old_logs(90); -- удалить логи старше 90 дней
```

### Проверка синхронизации
```sql
SELECT * FROM sync_statistics;
```

### Мониторинг производительности
```sql
-- Проверка размера таблиц
SELECT 
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size
FROM pg_tables 
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

## Устранение неполадок

### Проблемы с миграциями
1. Проверьте логи Supabase: `supabase logs`
2. Убедитесь, что PostgreSQL 17+ установлен
3. Проверьте права доступа к базе данных

### Проблемы с RLS
1. Убедитесь, что пользователь аутентифицирован
2. Проверьте политики доступа
3. Проверьте роль пользователя

### Проблемы с синхронизацией
1. Проверьте статус устройств в `device_sync_status`
2. Просмотрите операции в `sync_operations`
3. Проверьте конфликты в `sync_conflicts`

## Обновления и изменения

При внесении изменений в схему:

1. Создайте новую миграцию
2. Протестируйте локально
3. Примените в тестовой среде
4. Разверните в продакшн

## Поддержка

При возникновении проблем:

1. Проверьте логи Supabase
2. Убедитесь в корректности SQL синтаксиса
3. Проверьте совместимость версий PostgreSQL
4. Обратитесь к документации Supabase

## Заключение

Эта схема базы данных предоставляет полнофункциональную основу для системы управления складом оборудования с поддержкой:

- Многопользовательского доступа
- Синхронизации между устройствами
- Аудита и логирования
- Уведомлений и отчетности
- Масштабируемости и производительности

Все миграции протестированы и готовы к использованию в продакшн среде.
