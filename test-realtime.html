<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç Real-Time –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px;
        }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 5px; 
        }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        .log { 
            background-color: #f8f9fa; 
            border: 1px solid #dee2e6; 
            padding: 15px; 
            height: 300px; 
            overflow-y: auto; 
            font-family: monospace; 
            font-size: 12px;
        }
        button { 
            background-color: #007bff; 
            color: white; 
            border: none; 
            padding: 10px 15px; 
            margin: 5px; 
            border-radius: 5px; 
            cursor: pointer; 
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
    </style>
</head>
<body>
    <h1>üöÄ –¢–µ—Å—Ç Real-Time –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏</h1>
    
    <div id="status" class="status disconnected">
        ‚ùå –ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ
    </div>
    
    <div>
        <button id="connectBtn">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
        <button id="disconnectBtn" disabled>–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
        <button id="clearBtn">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
    </div>
    
    <h3>–¢–µ—Å—Ç–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:</h3>
    <div>
        <button id="testEquipment">–¢–µ—Å—Ç Equipment Update</button>
        <button id="testShipment">–¢–µ—Å—Ç Shipment Update</button>
        <button id="testCategory">–¢–µ—Å—Ç Category Update</button>
    </div>
    
    <h3>–õ–æ–≥ —Å–æ–±—ã—Ç–∏–π:</h3>
    <div id="log" class="log"></div>

    <script>
        const API_URL = 'http://localhost:3001';
        let eventSource = null;
        
        const statusEl = document.getElementById('status');
        const logEl = document.getElementById('log');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const clearBtn = document.getElementById('clearBtn');
        
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logLine = `[${timestamp}] ${message}\n`;
            logEl.textContent += logLine;
            logEl.scrollTop = logEl.scrollHeight;
        }
        
        function updateStatus(connected, message = '') {
            if (connected) {
                statusEl.textContent = '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ ' + message;
                statusEl.className = 'status connected';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            } else {
                statusEl.textContent = '‚ùå –ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ ' + message;
                statusEl.className = 'status disconnected';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            }
        }
        
        function connect() {
            if (eventSource) {
                eventSource.close();
            }
            
                  addLog('üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ ' + API_URL + '/functions/v1/events?stream=stream');
      eventSource = new EventSource(API_URL + '/functions/v1/events?stream=stream');
            
            eventSource.onopen = function(event) {
                addLog('‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                updateStatus(true);
            };
            
            eventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    addLog('üì® –ü–æ–ª—É—á–µ–Ω–æ: ' + JSON.stringify(data, null, 2));
                } catch (e) {
                    addLog('üì® –ü–æ–ª—É—á–µ–Ω–æ (raw): ' + event.data);
                }
            };
            
            eventSource.onerror = function(event) {
                addLog('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + event.type);
                updateStatus(false, '(–æ—à–∏–±–∫–∞)');
            };
        }
        
        function disconnect() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
                addLog('üîå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ');
                updateStatus(false);
            }
        }
        
        async function sendTestNotification(type, action = 'update') {
            const testData = {
                equipment: { id: '1', name: 'Test Equipment', status: 'available' },
                shipment: { id: '1', number: 'SHIP-001', status: 'preparing' },
                category: { id: '1', name: 'Test Category' }
            };
            
            try {
                addLog(`üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: ${type}/${action}`);
                const response = await fetch(`${API_URL}/functions/v1/events/notify/${type}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: action,
                        data: testData[type] || { test: true }
                    })
                });
                
                if (response.ok) {
                    addLog(`‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${type}/${action}`);
                } else {
                    addLog(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                addLog(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ${error.message}`);
            }
        }
        
        // Event listeners
        connectBtn.addEventListener('click', connect);
        disconnectBtn.addEventListener('click', disconnect);
        clearBtn.addEventListener('click', () => logEl.textContent = '');
        
        document.getElementById('testEquipment').addEventListener('click', () => 
            sendTestNotification('equipment', 'update'));
        document.getElementById('testShipment').addEventListener('click', () => 
            sendTestNotification('shipment', 'create'));
        document.getElementById('testCategory').addEventListener('click', () => 
            sendTestNotification('category', 'delete'));
        
        // –ê–≤—Ç–æ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        addLog('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ù–∞–∂–º–∏—Ç–µ "–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è" –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ç–µ—Å—Ç–∞.');
        addLog('üí° –°–Ω–∞—á–∞–ª–∞ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ http://localhost:3001');
    </script>
</body>
</html>
