<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –º–µ–∂–¥—É –±—Ä–∞—É–∑–µ—Ä–∞–º–∏</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        #log { background: #f8f9fa; padding: 10px; border-radius: 5px; max-height: 400px; overflow-y: auto; }
        .device-info { background: #fff3cd; border-color: #ffeaa7; }
    </style>
</head>
<body>
    <h1>–¢–µ—Å—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –º–µ–∂–¥—É –±—Ä–∞—É–∑–µ—Ä–∞–º–∏</h1>
    
    <div class="test-section device-info">
        <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ</h3>
        <p><strong>Device ID:</strong> <span id="device-id">–ó–∞–≥—Ä—É–∑–∫–∞...</span></p>
        <p><strong>User Agent:</strong> <span id="user-agent"></span></p>
        <p><strong>–í—Ä–µ–º—è:</strong> <span id="current-time"></span></p>
    </div>
    
    <div class="test-section info">
        <h3>–°—Ç–∞—Ç—É—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏</h3>
        <p>–ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏...</p>
        <div id="connection-status">–ü—Ä–æ–≤–µ—Ä–∫–∞...</div>
    </div>
    
    <div class="test-section">
        <h3>–¢–µ—Å—Ç—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏</h3>
        <button onclick="testSendOperation()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –æ–ø–µ—Ä–∞—Ü–∏—é</button>
        <button onclick="testReceiveOperations()">–ü–æ–ª—É—á–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞</button>
        <button onclick="testFullSync()">–ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏</button>
        <button onclick="clearLog()">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
    </div>
    
    <div class="test-section">
        <h3>–õ–æ–≥ —Ç–µ—Å—Ç–æ–≤</h3>
        <div id="log"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://xekoibwvbsbpjcjqmjlu.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhla29pYnd2YnNicGpjanFtamx1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMDE5NzEsImV4cCI6MjA3MTg3Nzk3MX0.q4InFPBY5l8zZKpryR0zOt9OID7eTA-2MmRf78QKi1k';
        
        let deviceId = '';
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            logEntry.style.color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        function generateDeviceId() {
            const existingId = localStorage.getItem('warehouse-device-id');
            if (existingId && existingId.length > 10) {
                return existingId;
            }
            
            const hash = Math.abs(navigator.userAgent.split('').reduce((a, b) => {
                a = ((a << 5) - a) + b.charCodeAt(0);
                return a & a;
            }, 0));
            
            const deviceId = `device_${Math.abs(hash).toString(36)}_${Date.now().toString(36)}`;
            localStorage.setItem('warehouse-device-id', deviceId);
            return deviceId;
        }
        
        async function testSendOperation() {
            log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—É—é –æ–ø–µ—Ä–∞—Ü–∏—é...');
            
            const testOperation = {
                id: `test_${Date.now()}`,
                table: 'equipment',
                operation: 'create',
                data: {
                    name: `–¢–µ—Å—Ç–æ–≤–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ ${Date.now()}`,
                    category: '–ö–æ–º–ø—å—é—Ç–µ—Ä—ã',
                    status: 'available',
                    serial_number: `TEST-${Date.now()}`,
                    description: '–¢–µ—Å—Ç–æ–≤–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏'
                },
                timestamp: Date.now(),
                deviceId: deviceId,
                userId: null,
                hash: `test-hash-${Date.now()}`,
                status: 'pending',
                retryCount: 0
            };
            
            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/sync`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        operations: [testOperation],
                        deviceId: deviceId,
                        lastSync: 0
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ –û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞! –û—Ç–≤–µ—Ç: ${JSON.stringify(data)}`, 'success');
                } else {
                    const errorText = await response.text();
                    log(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏! –°—Ç–∞—Ç—É—Å: ${response.status}, –û—Ç–≤–µ—Ç: ${errorText}`, 'error');
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏: ${error.message}`, 'error');
            }
        }
        
        async function testReceiveOperations() {
            log('üì• –ü–æ–ª—É—á–∞–µ–º –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞...');
            
            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/sync?deviceId=${deviceId}&lastSync=0`, {
                    method: 'GET',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ –û–ø–µ—Ä–∞—Ü–∏–∏ –ø–æ–ª—É—á–µ–Ω—ã! –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${data.data?.length || 0}`, 'success');
                    if (data.data && data.data.length > 0) {
                        log(`üìã –û–ø–µ—Ä–∞—Ü–∏–∏: ${JSON.stringify(data.data, null, 2)}`);
                    }
                } else {
                    const errorText = await response.text();
                    log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è! –°—Ç–∞—Ç—É—Å: ${response.status}, –û—Ç–≤–µ—Ç: ${errorText}`, 'error');
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π: ${error.message}`, 'error');
            }
        }
        
        async function testFullSync() {
            log('üîÑ –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ–ª–Ω—ã–π —Ç–µ—Å—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏...');
            
            // –°–Ω–∞—á–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–ø–µ—Ä–∞—Ü–∏—é
            await testSendOperation();
            
            // –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // –ó–∞—Ç–µ–º –ø–æ–ª—É—á–∞–µ–º –æ–ø–µ—Ä–∞—Ü–∏–∏
            await testReceiveOperations();
            
            log('‚úÖ –ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω!', 'success');
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = function() {
            deviceId = generateDeviceId();
            document.getElementById('device-id').textContent = deviceId;
            document.getElementById('user-agent').textContent = navigator.userAgent;
            document.getElementById('current-time').textContent = new Date().toLocaleString();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
            fetch(`${SUPABASE_URL}/functions/v1/sync?deviceId=${deviceId}&lastSync=0`, {
                method: 'GET',
                headers: {
                    'apikey': SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                }
            })
            .then(response => {
                if (response.ok) {
                    document.getElementById('connection-status').innerHTML = '‚úÖ API —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–µ–Ω';
                    document.getElementById('connection-status').parentElement.className = 'test-section success';
                } else {
                    document.getElementById('connection-status').innerHTML = '‚ùå API —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
                    document.getElementById('connection-status').parentElement.className = 'test-section error';
                }
            })
            .catch(error => {
                document.getElementById('connection-status').innerHTML = '‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è';
                document.getElementById('connection-status').parentElement.className = 'test-section error';
            });
        };
    </script>
</body>
</html>
