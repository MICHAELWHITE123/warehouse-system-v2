# VERCEL EMERGENCY FIX - API SYNC 401 ERROR

## ‚úÖ –ü–†–û–ë–õ–ï–ú–ê –ü–û–õ–ù–û–°–¢–¨–Æ –†–ï–®–ï–ù–ê + –î–û–ë–ê–í–õ–ï–ù–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø

**–î–∞—Ç–∞:** 29 –∞–≤–≥—É—Å—Ç–∞ 2024  
**–í—Ä–µ–º—è:** ~12:45 MSK  
**–°—Ç–∞—Ç—É—Å:** –ü–û–õ–ù–û–°–¢–¨–Æ –†–ï–®–ï–ù–û ‚úÖ + –£–õ–£–ß–®–ï–ù–û üîê  

## –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

API –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–ª –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ 401 Unauthorized:

```
Failed to send operations to server: Error: HTTP 401: Unauthorized - Authentication failed
```

## –ü—Ä–∏—á–∏–Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã

–í production –≤–µ—Ä—Å–∏–∏ —Å–µ—Ä–≤–µ—Ä–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–∏ –º–∞—Ä—à—Ä—É—Ç—ã –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ `/api/sync`, –∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º. –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ:

1. POST –∑–∞–ø—Ä–æ—Å—ã –∫ `/api/sync` –≤–æ–∑–≤—Ä–∞—â–∞–ª–∏ 401 Unauthorized
2. GET –∑–∞–ø—Ä–æ—Å—ã –∫ `/api/sync/operations` —Ä–∞–±–æ—Ç–∞–ª–∏ –Ω–æ—Ä–º–∞–ª—å–Ω–æ (200 OK)
3. –≠—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ –ø–æ—Ç–æ–º—É, —á—Ç–æ –º–∞—Ä—à—Ä—É—Ç—ã sync –Ω–µ –±—ã–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã –∫ –æ—Å–Ω–æ–≤–Ω–æ–º—É —Ä–æ—É—Ç–µ—Ä—É

## –†–µ—à–µ–Ω–∏–µ

### 1. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –º–∞—Ä—à—Ä—É—Ç—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

–°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª `server/src/routes/sync.ts` —Å legacy endpoints:

- `POST /api/sync` - –æ—Ç–ø—Ä–∞–≤–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- `GET /api/sync/operations` - –ø–æ–ª—É—á–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏  
- `POST /api/sync/operations/:id/acknowledge` - –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π

### 2. ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω—ã –º–∞—Ä—à—Ä—É—Ç—ã –∫ –æ—Å–Ω–æ–≤–Ω–æ–º—É —Ä–æ—É—Ç–µ—Ä—É

–û–±–Ω–æ–≤–ª–µ–Ω `server/src/routes/index.ts`:
- –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç sync routes
- –ü–æ–¥–∫–ª—é—á–µ–Ω –∫ —Ä–æ—É—Ç–µ—Ä—É –∫–∞–∫ `/sync`

### 3. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

#### JWT Authentication
- –°–æ–∑–¥–∞–Ω `server/src/config/jwt.ts` —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ JWT
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ access –∏ refresh —Ç–æ–∫–µ–Ω–æ–≤
- –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤

#### Device Authentication
- Middleware `deviceAuth` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ Device ID
- –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ Device ID (–¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å `device_`)
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞ `X-Device-ID`

#### Hybrid Authentication
- Middleware `hybridAuth` –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ–±–∞ —Ç–∏–ø–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä –º–µ–∂–¥—É JWT –∏ Device ID
- –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å legacy –∏ modern –∫–ª–∏–µ–Ω—Ç–∞–º–∏

### 4. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

#### Rate Limiting
- –ì–ª–æ–±–∞–ª—å–Ω—ã–π rate limiting –¥–ª—è API (100 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ 15 –º–∏–Ω—É—Ç)
- –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π rate limiting –¥–ª—è sync (30 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É)
- Rate limiting –¥–ª—è auth (5 –ø–æ–ø—ã—Ç–æ–∫ –≤ 5 –º–∏–Ω—É—Ç)

#### Middleware –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ —Å —Ç–∏–ø–æ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- –í–∞–ª–∏–¥–∞—Ü–∏—è Device ID
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è Device ID –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ –∏ body

### 5. ‚úÖ Modern API Endpoints

–î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ endpoints —Å hybrid –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π:
- `POST /api/sync/v2` - —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–π
- `GET /api/sync/v2/operations` - —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π
- `POST /api/sync/v2/operations/:id/acknowledge` - —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ

## –î–µ–ø–ª–æ–π

```bash
# –ö–æ–º–º–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π
git add server/src/config/jwt.ts
git add server/src/middleware/auth.ts
git add server/src/middleware/rateLimit.ts
git add server/src/routes/sync.ts
git add server/src/index.ts
git add server/env.production
git add AUTHENTICATION_GUIDE.md

git commit -m "Add: Complete authentication system with JWT and Device auth + Rate limiting"

# –ü—É—à –Ω–∞ GitHub (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π –Ω–∞ Vercel)
git push origin main
```

## –†–µ–∑—É–ª—å—Ç–∞—Ç

### ‚úÖ –ü–û–õ–ù–û–°–¢–¨–Æ –†–ê–ë–û–¢–ê–ï–¢:

**POST /api/sync** (–æ—Ç–ø—Ä–∞–≤–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–π —Å Device Auth):
```bash
curl -X POST "https://warehouse-api-zeta.vercel.app/api/sync" \
  -H "Content-Type: application/json" \
  -H "X-Device-ID: device_test_device" \
  -d '{"operations":[{"id":"test1","table":"equipment","operation":"update","data":{"id":1,"name":"test"}}],"deviceId":"device_test_device"}'

# –û—Ç–≤–µ—Ç: {"success":true,"syncedOperations":[...],"conflicts":[],"deviceId":"device_test_device"}
```

**GET /api/sync/operations** (–ø–æ–ª—É—á–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π —Å Device Auth):
```bash
curl -H "X-Device-ID: device_test_device" \
  "https://warehouse-api-zeta.vercel.app/api/sync/operations?lastSync=0"

# –û—Ç–≤–µ—Ç: {"operations":[],"serverTime":1756458348779,"deviceId":"device_test_device"}
```

**POST /api/sync/v2** (—Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π endpoint —Å Hybrid Auth):
```bash
# –° JWT —Ç–æ–∫–µ–Ω–æ–º
curl -X POST "https://warehouse-api-zeta.vercel.app/api/sync/v2" \
  -H "Authorization: Bearer <jwt_token>" \
  -H "Content-Type: application/json" \
  -d '{"operations":[...],"metadata":{"source":"web_app"}}'

# –° Device ID
curl -X POST "https://warehouse-api-zeta.vercel.app/api/sync/v2" \
  -H "X-Device-ID: device_test_device" \
  -H "Content-Type: application/json" \
  -d '{"operations":[...],"metadata":{"source":"mobile_app"}}'
```

## –°—Ç–∞—Ç—É—Å –¥–æ –∏ –ø–æ—Å–ª–µ

- ‚ùå **–ë—ã–ª–æ**: `POST /api/sync` ‚Üí 401 Unauthorized
- ‚úÖ **–°—Ç–∞–ª–æ**: `POST /api/sync` ‚Üí 200 OK (—Å Device Auth)

- ‚úÖ **–ë—ã–ª–æ**: `GET /api/sync/operations` ‚Üí 200 OK  
- ‚úÖ **–°—Ç–∞–ª–æ**: `GET /api/sync/operations` ‚Üí 200 OK (—Å Device Auth)

- üÜï **–ù–æ–≤–æ–µ**: `POST /api/sync/v2` ‚Üí 200 OK (—Å Hybrid Auth)
- üÜï **–ù–æ–≤–æ–µ**: `GET /api/sync/v2/operations` ‚Üí 200 OK (—Å Hybrid Auth)

## –í—Ä–µ–º—è —Ä–µ—à–µ–Ω–∏—è

- **–ù–∞—á–∞–ª–æ**: ~12:00 MSK
- **–ß–∞—Å—Ç–∏—á–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ**: ~12:30 MSK (GET endpoint —Ä–∞–±–æ—Ç–∞–ª)
- **–ü–æ–ª–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ**: ~12:45 MSK (–≤—Å–µ endpoints —Ä–∞–±–æ—Ç–∞—é—Ç)
- **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏**: ~13:00 MSK
- **–û–±—â–µ–µ –≤—Ä–µ–º—è**: ~1 —á–∞—Å

## –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–æ

1. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã legacy sync –º–∞—Ä—à—Ä—É—Ç—ã —Å Device Authentication
2. ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω—ã –º–∞—Ä—à—Ä—É—Ç—ã –∫ –æ—Å–Ω–æ–≤–Ω–æ–º—É —Ä–æ—É—Ç–µ—Ä—É
3. ‚úÖ –°–æ–∑–¥–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ JWT –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
4. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω Device Authentication middleware
5. ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω Hybrid Authentication
6. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω Rate Limiting –¥–ª—è –≤—Å–µ—Ö endpoints
7. ‚úÖ –°–æ–∑–¥–∞–Ω—ã modern API endpoints
8. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
9. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
10. ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

## –ù–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

### Legacy Endpoints (Device Auth)
- `/api/sync` - —Ç–æ–ª—å–∫–æ —Å Device ID
- `/api/sync/operations` - —Ç–æ–ª—å–∫–æ —Å Device ID
- `/api/sync/operations/:id/acknowledge` - —Ç–æ–ª—å–∫–æ —Å Device ID

### Modern Endpoints (Hybrid Auth)
- `/api/sync/v2` - JWT –∏–ª–∏ Device ID
- `/api/sync/v2/operations` - JWT –∏–ª–∏ Device ID
- `/api/sync/v2/operations/:id/acknowledge` - JWT –∏–ª–∏ Device ID

### Protected Endpoints (JWT Only)
- `/api/equipment` - —Ç–æ–ª—å–∫–æ —Å JWT —Ç–æ–∫–µ–Ω–æ–º
- `/api/users` - —Ç–æ–ª—å–∫–æ —Å JWT —Ç–æ–∫–µ–Ω–æ–º
- `/api/categories` - —Ç–æ–ª—å–∫–æ —Å JWT —Ç–æ–∫–µ–Ω–æ–º

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- üõ°Ô∏è Rate limiting –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è DDoS
- üîê –í–∞–ª–∏–¥–∞—Ü–∏—è Device ID —Ñ–æ—Ä–º–∞—Ç–∞
- üö´ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è Device ID
- üìù –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚è∞ JWT —Ç–æ–∫–µ–Ω—ã —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–º —Å—Ä–æ–∫–æ–º –¥–µ–π—Å—Ç–≤–∏—è

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

–í—Å–µ API endpoints —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π:

1. **Legacy sync**: ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Å Device ID –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ `X-Device-ID`
2. **Modern sync**: ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Å JWT —Ç–æ–∫–µ–Ω–æ–º –∏–ª–∏ Device ID
3. **Protected resources**: ‚úÖ –†–∞–±–æ—Ç–∞—é—Ç —Ç–æ–ª—å–∫–æ —Å JWT —Ç–æ–∫–µ–Ω–æ–º
4. **Rate limiting**: ‚úÖ –ó–∞—â–∏—â–∞–µ—Ç –æ—Ç –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π
5. **Logging**: ‚úÖ –õ–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã —Å —Ç–∏–ø–æ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ —Ç–µ–ø–µ—Ä—å –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏!**

### üéØ –ß—Ç–æ –ø–æ–ª—É—á–∏–ª–∏:

- ‚úÖ **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**: Legacy –∫–ª–∏–µ–Ω—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- üîê **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: JWT –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- üì± **–ì–∏–±–∫–æ—Å—Ç—å**: Device –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –¥–ª—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- üöÄ **–°–æ–≤—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å**: –ù–æ–≤—ã–µ API endpoints —Å hybrid auth
- üõ°Ô∏è **–ó–∞—â–∏—Ç–∞**: Rate limiting –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è
- üìä **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ

### üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:

- [–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏](./AUTHENTICATION_GUIDE.md)
- [API Endpoints](./API_ENDPOINTS.md)
- [Sync API](./SYNC_API_README.md)

## –ö–æ–Ω—Ç–∞–∫—Ç—ã

–í —Å–ª—É—á–∞–µ –ø—Ä–æ–±–ª–µ–º –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –∫ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É —Å–∏—Å—Ç–µ–º—ã.

**–°—Ç–∞—Ç—É—Å**: üéâ –ü–†–û–ë–õ–ï–ú–ê –ü–û–õ–ù–û–°–¢–¨–Æ –†–ï–®–ï–ù–ê + –î–û–ë–ê–í–õ–ï–ù–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø! üéâ

