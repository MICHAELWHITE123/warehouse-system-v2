# Настройка системы синхронизации

## Обзор

Система синхронизации позволяет автоматически синхронизировать данные между разными устройствами в реальном времени. Все изменения, сделанные на одном устройстве, автоматически передаются на другие устройства через сервер.

## Компоненты системы

### 1. Клиентская часть (Frontend)

- **SyncAdapter** (`src/database/syncAdapter.ts`) - основной класс для управления синхронизацией
- **SyncStatus** (`src/components/SyncStatus.tsx`) - компонент для отображения статуса синхронизации
- **useSync** (`src/hooks/useSync.ts`) - хук для управления синхронизацией в React компонентах

### 2. Серверная часть (Backend)

- **SyncController** (`server/src/controllers/SyncController.ts`) - контроллер для обработки запросов синхронизации
- **Sync Routes** (`server/src/routes/sync.ts`) - API маршруты для синхронизации
- **Database Tables** - таблицы для хранения операций синхронизации

## Настройка

### 1. Переменные окружения

Создайте файл `.env` в корне проекта:

```bash
# API URL для синхронизации
VITE_API_URL=http://localhost:3001/api

# Настройки сервера
PORT=3001
CORS_ORIGIN=http://localhost:5173
```

### 2. Запуск сервера

```bash
cd server
npm install
npm run dev
```

### 3. Запуск клиента

```bash
npm install
npm run dev
```

## Как это работает

### 1. Автоматическая синхронизация

- Система автоматически синхронизируется каждые 30 секунд
- При изменении данных они добавляются в очередь синхронизации
- Синхронизация происходит в фоновом режиме

### 2. Очередь операций

Все операции (создание, обновление, удаление) добавляются в локальную очередь:

```typescript
// Пример добавления операции в очередь
syncAdapter.addToSyncQueue('equipment', 'create', equipmentData);
syncAdapter.addToSyncQueue('equipment', 'update', updatedEquipment);
syncAdapter.addToSyncQueue('equipment', 'delete', { id: equipmentId });
```

### 3. Разрешение конфликтов

При обнаружении конфликтов система предлагает пользователю выбрать:
- Использовать локальную версию
- Использовать удаленную версию
- Разрешить конфликт вручную

### 4. Статус синхронизации

Компонент `SyncStatus` отображает:
- Статус подключения (онлайн/офлайн)
- Количество операций в очереди
- Количество конфликтов
- Время последней синхронизации
- Информацию об устройстве

## API Endpoints

### POST /api/sync
Синхронизация операций между устройствами

**Request Body:**
```json
{
  "operations": [
    {
      "id": "sync_1234567890",
      "table": "equipment",
      "operation": "create",
      "data": { ... },
      "timestamp": 1234567890,
      "deviceId": "device_123",
      "userId": "user_456"
    }
  ],
  "deviceId": "device_123",
  "lastSync": 1234567890
}
```

### GET /api/sync/status
Получение статуса синхронизации

**Query Parameters:**
- `deviceId` - ID устройства

### GET /api/sync/conflicts
Получение списка конфликтов

### POST /api/sync/conflicts/:id/resolve
Разрешение конфликта

## Интеграция в существующие сервисы

### Пример интеграции в EquipmentService:

```typescript
import { syncAdapter } from '../syncAdapter';

export class EquipmentService {
  createEquipment(equipment: CreateEquipment): DbEquipment {
    const result = this.db.insert('equipment', equipment);
    
    // Добавляем в очередь синхронизации
    syncAdapter.addToSyncQueue('equipment', 'create', result);
    
    return result;
  }

  updateEquipment(id: number, updates: UpdateEquipment): DbEquipment | null {
    const result = this.db.update('equipment', id, updates);
    
    if (result) {
      // Добавляем в очередь синхронизации
      syncAdapter.addToSyncQueue('equipment', 'update', result);
    }
    
    return result;
  }
}
```

## Мониторинг и отладка

### 1. Логи в консоли браузера

```typescript
// Включить подробное логирование
localStorage.setItem('debug-sync', 'true');

// Проверить статус синхронизации
console.log(syncAdapter.getSyncStatus());

// Проверить информацию об устройстве
console.log(syncAdapter.getDeviceInfo());
```

### 2. Проверка очереди синхронизации

```typescript
// Количество операций в очереди
const pendingCount = syncAdapter.getPendingOperationsCount();

// Количество конфликтов
const conflictsCount = syncAdapter.getConflictsCount();

// Принудительная синхронизация
await syncAdapter.forceSync();
```

### 3. Очистка очереди

```typescript
// Очистить очередь синхронизации (только для отладки)
syncAdapter.clearSyncQueue();
```

## Безопасность

### 1. Аутентификация

Все запросы синхронизации требуют валидный JWT токен:

```typescript
headers: {
  'Authorization': `Bearer ${localStorage.getItem('auth-token')}`
}
```

### 2. Валидация данных

Сервер проверяет:
- Формат операций
- Права доступа пользователя
- Валидность данных

### 3. Ограничение частоты

- Максимум 100 операций за один запрос
- Таймаут 30 секунд на запрос
- Автоматическая синхронизация каждые 30 секунд

## Устранение неполадок

### 1. Синхронизация не работает

**Проверьте:**
- Подключение к интернету
- Статус сервера API
- Валидность токена авторизации
- Консоль браузера на ошибки

### 2. Данные не обновляются

**Возможные причины:**
- Конфликты синхронизации
- Ошибки в формате данных
- Проблемы с базой данных

### 3. Медленная синхронизация

**Рекомендации:**
- Увеличьте интервал автоматической синхронизации
- Проверьте производительность сервера
- Оптимизируйте размер передаваемых данных

## Производительность

### 1. Оптимизация

- Синхронизация только измененных данных
- Сжатие данных при передаче
- Кэширование на клиенте

### 2. Масштабирование

- Поддержка множественных устройств
- Очередь операций на сервере
- Асинхронная обработка

## Поддержка

При возникновении проблем:

1. Проверьте логи в консоли браузера
2. Проверьте статус сервера API
3. Убедитесь в корректности настроек
4. Обратитесь к документации API

## Обновления

Система синхронизации автоматически обновляется при:
- Изменении структуры данных
- Обновлении API
- Изменении логики синхронизации

Все изменения обратно совместимы и не требуют ручного вмешательства.
